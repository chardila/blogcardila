---
import PageLayout from "@/layouts/Base.astro";
import { fetchBGGCollection } from "@/utils/bgg";

const meta = {
	title: "Juegos de Mesa",
	description: "Mi colección de juegos de mesa y estadísticas en BoardGameGeek",
};

const BGG_USERNAME = "cardila";
const token = import.meta.env.BGG_TOKEN;

let collection;
let error = null;

try {
	collection = await fetchBGGCollection(BGG_USERNAME, token);
} catch (e) {
	error = e instanceof Error ? e.message : 'Error al cargar la colección';
	collection = {
		totalGames: 0,
		expansions: 0,
		totalPlays: 0,
		playsPerYear: {},
		games: [],
	};
}

const ITEMS_PER_PAGE = 20;
const totalPages = Math.ceil(collection.games.length / ITEMS_PER_PAGE);
const paginatedGames = collection.games.slice(0, ITEMS_PER_PAGE);

// Get recent years for plays
const recentYears = Object.keys(collection.playsPerYear)
	.sort((a, b) => parseInt(b) - parseInt(a))
	.slice(0, 3);
---

<PageLayout meta={meta}>
	<div class="space-y-8">
		<div>
			<h1 class="title">Juegos de Mesa</h1>
			<p class="mt-2 opacity-70">
				Mi colección de juegos de mesa y estadísticas en <a href="https://boardgamegeek.com/user/cardila" target="_blank" rel="noopener noreferrer" class="cactus-link">BoardGameGeek</a>
			</p>
		</div>

		{error ? (
			<div class="bg-red-50 border border-red-200 p-4 text-red-800 dark:bg-red-900/20 dark:border-red-800 dark:text-red-200 rounded-lg">
				<strong>Error:</strong> {error}
			</div>
		) : (
			<>
				<!-- Summary Stats -->
				<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
					<div class="stat-card">
						<div class="stat-value">{collection.totalGames}</div>
						<div class="stat-label">Juegos</div>
					</div>
					<div class="stat-card">
						<div class="stat-value">{collection.expansions}</div>
						<div class="stat-label">Expansiones</div>
					</div>
					<div class="stat-card">
						<div class="stat-value">{collection.totalPlays}</div>
						<div class="stat-label">Partidas Totales</div>
					</div>
					<div class="stat-card">
						<div class="stat-value">{recentYears.length > 0 ? collection.playsPerYear[recentYears[0]] || 0 : 0}</div>
						<div class="stat-label">Partidas {recentYears[0] || 'Este Año'}</div>
					</div>
				</div>

				<!-- Plays by Year -->
				{recentYears.length > 0 && (
					<div class="info-card">
						<h2 class="text-lg font-semibold mb-3">Partidas por Año</h2>
						<div class="grid grid-cols-3 gap-4">
							{recentYears.map(year => (
								<div>
									<div class="font-semibold text-accent">{year}</div>
									<div class="text-2xl font-bold">{collection.playsPerYear[year]}</div>
								</div>
							))}
						</div>
					</div>
				)}

				<!-- Games Table -->
				<div class="info-card overflow-x-auto">
					<h2 class="text-lg font-semibold mb-4">Colección ({collection.games.length} juegos)</h2>

					<table class="games-table">
						<thead>
							<tr>
								<th>Imagen</th>
								<th>Nombre</th>
								<th>Partidas</th>
								<th>Mi Nota</th>
								<th>BGG</th>
							</tr>
						</thead>
						<tbody>
							{paginatedGames.map(game => (
								<tr>
									<td class="thumbnail-cell">
										{game.thumbnail ? (
											<img src={game.thumbnail} alt={game.name} loading="lazy" />
										) : (
											<div class="no-image">?</div>
										)}
									</td>
									<td class="name-cell">
										<a
											href={`https://boardgamegeek.com/boardgame/${game.id}`}
											target="_blank"
											rel="noopener noreferrer"
											class="game-name"
										>
											{game.name}
										</a>
										{game.isExpansion && <span class="expansion-badge">Exp</span>}
									</td>
									<td class="text-center font-semibold">{game.numPlays}</td>
									<td class="text-center">{game.rating && game.rating > 0 ? game.rating.toFixed(1) : '—'}</td>
									<td class="text-center">{game.averageRating ? game.averageRating.toFixed(1) : '—'}</td>
								</tr>
							))}
						</tbody>
					</table>

					<!-- Pagination -->
					{totalPages > 1 && (
						<div class="pagination">
							<div class="pagination-info">
								Página 1 de {totalPages}
							</div>
							<div class="pagination-buttons">
								<a href="/boardgames/2/" class="pagination-btn">
									Siguiente →
								</a>
							</div>
						</div>
					)}
				</div>

				<!-- External Link -->
				<div class="info-card text-center">
					<p class="mb-4">Ver más detalles en mi perfil de BoardGameGeek:</p>
					<a
						href="https://boardgamegeek.com/user/cardila"
						target="_blank"
						rel="noopener noreferrer"
						class="view-button"
					>
						Ver Perfil en BGG
					</a>
				</div>
			</>
		)}
	</div>
</PageLayout>

<style>
	.stat-card {
		background-color: var(--color-accent);
		padding: 1.5rem;
		border-radius: 0.5rem;
		text-align: center;
	}

	.stat-value {
		font-size: 2rem;
		font-weight: 700;
		color: var(--color-accent-2);
	}

	.stat-label {
		font-size: 0.875rem;
		margin-top: 0.25rem;
		opacity: 0.9;
		color: var(--color-accent-2);
	}

	.info-card {
		background-color: var(--theme-bg-offset);
		padding: 1.5rem;
		border-radius: 0.5rem;
	}

	.games-table {
		width: 100%;
		border-collapse: collapse;
		font-size: 0.875rem;
	}

	.games-table thead {
		border-bottom: 2px solid var(--color-accent);
	}

	.games-table th {
		padding: 0.75rem 0.5rem;
		text-align: left;
		font-weight: 600;
		white-space: nowrap;
	}

	.games-table td {
		padding: 0.75rem 0.5rem;
		border-bottom: 1px solid var(--theme-divider);
	}

	.games-table tbody tr:hover {
		background-color: var(--theme-bg-offset);
	}

	.thumbnail-cell {
		width: 50px;
	}

	.thumbnail-cell img {
		width: 50px;
		height: 50px;
		object-fit: cover;
		border-radius: 0.25rem;
	}

	.no-image {
		width: 50px;
		height: 50px;
		display: flex;
		align-items: center;
		justify-content: center;
		background-color: var(--theme-divider);
		border-radius: 0.25rem;
		opacity: 0.5;
	}

	.name-cell {
		min-width: 200px;
	}

	.game-name {
		color: var(--color-link);
		text-decoration: none;
		font-weight: 500;
	}

	.game-name:hover {
		text-decoration: underline;
	}

	.expansion-badge {
		display: inline-block;
		margin-left: 0.5rem;
		padding: 0.125rem 0.375rem;
		background-color: var(--color-accent);
		color: var(--color-accent-2);
		font-size: 0.75rem;
		border-radius: 0.25rem;
		font-weight: 600;
	}

	.pagination {
		margin-top: 1.5rem;
		display: flex;
		justify-content: space-between;
		align-items: center;
		flex-wrap: wrap;
		gap: 1rem;
	}

	.pagination-info {
		font-size: 0.875rem;
		opacity: 0.7;
	}

	.pagination-buttons {
		display: flex;
		gap: 0.5rem;
	}

	.pagination-btn {
		padding: 0.5rem 1rem;
		background-color: var(--color-accent);
		color: var(--color-accent-2);
		text-decoration: none;
		border-radius: 0.375rem;
		font-weight: 600;
		font-size: 0.875rem;
		transition: opacity 0.2s;
	}

	.pagination-btn:hover {
		opacity: 0.9;
	}

	.view-button {
		display: inline-block;
		padding: 0.75rem 2rem;
		background-color: var(--color-accent);
		color: var(--color-accent-2);
		text-decoration: none;
		border-radius: 0.5rem;
		font-weight: 600;
		transition: all 0.2s;
	}

	.view-button:hover {
		opacity: 0.9;
		transform: translateY(-2px);
	}

	@media (max-width: 768px) {
		.games-table {
			font-size: 0.75rem;
		}

		.games-table th,
		.games-table td {
			padding: 0.5rem 0.25rem;
		}

		.thumbnail-cell img,
		.no-image {
			width: 40px;
			height: 40px;
		}

		.name-cell {
			min-width: 150px;
		}
	}
</style>
